@inherits LayoutComponentBase

<div class="app-layout">
    <aside class="sidebar">
        <div class="sidebar-brand">
            <div class="sidebar-brand-icon">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L3 7v2h18V7L12 2zm0 2.18L17.36 7H6.64L12 4.18zM5 11v6c0 .55.45 1 1 1h3v-8H5zm5 0v8h4v-8h-4zm5 0v8h3c.55 0 1-.45 1-1v-6h-4zM3 20v2h18v-2H3z"/>
                </svg>
            </div>
            <span class="sidebar-brand-text">Pefi Bank</span>
        </div>

        <NavMenu />

        @if (State.IsLoggedIn && customer != null)
        {
            <div class="sidebar-footer">
                <div class="sidebar-customer">
                    <div class="sidebar-customer-avatar">
                        @customer.FirstName[0]@customer.LastName[0]
                    </div>
                    <div>
                        <div class="sidebar-customer-name">@customer.FirstName @customer.LastName</div>
                        <div class="sidebar-customer-id">@customer.Email</div>
                    </div>
                </div>
                <a href="" class="sidebar-signout" @onclick="SignOut" @onclick:preventDefault>
                    <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="width:16px;height:16px;">
                        <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
                    </svg>
                    Sign Out
                </a>
            </div>
        }
    </aside>

    <main class="main-content">
        @Body
    </main>
</div>

@code {
    [Inject] private CustomerState State { get; set; } = default!;
    [Inject] private BankApiClient Api { get; set; } = default!;
    [Inject] private NavigationManager Nav { get; set; } = default!;

    private CustomerReadModel? customer;
    private bool hasRestoredAuth;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !hasRestoredAuth)
        {
            hasRestoredAuth = true;
            await State.RestoreAsync();
            if (State.IsLoggedIn)
            {
                await LoadCustomer();
            }
            StateHasChanged();
        }
    }

    protected override void OnInitialized()
    {
        State.OnChange += OnStateChanged;
    }

    private async void OnStateChanged()
    {
        if (State.IsLoggedIn && customer == null)
        {
            await LoadCustomer();
        }
        else if (!State.IsLoggedIn)
        {
            customer = null;
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadCustomer()
    {
        try
        {
            customer = await Api.GetCustomerAsync(State.CustomerId!.Value);
        }
        catch
        {
            // Silently ignore â€” customer may not exist yet (during registration)
        }
    }

    private void SignOut()
    {
        State.Clear();
        Nav.NavigateTo("/signin", forceLoad: false);
    }
}
