@page "/accounts"
@inject BankApiClient Api
@inject CustomerState State
@inject NavigationManager Nav

@if (!State.IsLoggedIn)
{
    <div class="page-header">
        <h1 class="page-title">Accounts</h1>
    </div>
    <div class="card" style="max-width: 400px;">
        <div class="empty-state">
            <div class="empty-state-title">Not signed in</div>
            <div class="empty-state-text">Please <a href="">sign in</a> to view your accounts.</div>
        </div>
    </div>
}
else
{
    <div class="page-header">
        <h1 class="page-title">Accounts</h1>
        <p class="page-subtitle">Manage your bank accounts</p>
    </div>

    <div class="card mb-4" style="max-width: 480px;">
        <div class="section-header">
            <h3 class="section-title">Open New Account</h3>
        </div>
        <div style="display: flex; gap: 10px; align-items: flex-end;">
            <div style="flex: 1;">
                <label class="form-label">Account Name</label>
                <input type="text" class="form-input" @bind="newAccountName" placeholder="e.g. Savings, Bills" />
            </div>
            <button class="btn btn-primary" @onclick="OpenAccount" disabled="@isLoading" style="height: 42px;">
                Open
            </button>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(message))
    {
        <div class="alert alert-success" style="max-width: 480px;">@message</div>
    }

    @if (isWaitingForConfirmation)
    {
        <div class="waiting-banner" style="max-width: 480px;">
            <div class="spinner"></div>
            <span>Opening your account, please wait...</span>
        </div>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-error" style="max-width: 480px;">@errorMessage</div>
    }

    @if (accounts == null)
    {
        <div class="loading-card">
            <div class="spinner"></div>
            <span>Loading accounts...</span>
        </div>
    }
    else if (accounts.Count == 0)
    {
        <div class="card">
            <div class="empty-state">
                <svg class="empty-state-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1H12c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
                </svg>
                <div class="empty-state-title">No accounts yet</div>
                <div class="empty-state-text">Open your first account above to get started.</div>
            </div>
        </div>
    }
    else
    {
        <div class="account-grid">
            @foreach (var acct in accounts)
            {
                <a href="accounts/@acct.Id" class="account-card">
                    <div class="account-card-header">
                        <span class="account-card-name">@acct.AccountName</span>
                        <span class="account-card-badge @(acct.IsClosed ? "badge-closed" : "badge-active")">
                            @(acct.IsClosed ? "Closed" : "Active")
                        </span>
                    </div>
                    <div class="account-card-sort-acct">
                        @acct.SortCode &middot; @acct.AccountNumber
                    </div>
                    <div class="account-card-balance">@acct.Balance.ToString("C")</div>
                    <div class="account-card-footer">
                        <span>Opened @acct.OpenedAt.ToString("dd MMM yyyy")</span>
                        <span>View &rarr;</span>
                    </div>
                </a>
            }
        </div>
    }
}

@code {
    private List<AccountReadModel>? accounts;
    private string newAccountName = string.Empty;
    private string? message;
    private string? errorMessage;
    private bool isLoading;
    private bool isWaitingForConfirmation;
    private CancellationTokenSource? sseCts;

    protected override async Task OnInitializedAsync()
    {
        if (State.IsLoggedIn)
        {
            await LoadAccounts();
        }
    }

    private async Task LoadAccounts()
    {
        accounts = await Api.GetAccountsAsync(State.CustomerId!.Value);
    }

    private async Task OpenAccount()
    {
        message = null;
        errorMessage = null;

        if (string.IsNullOrWhiteSpace(newAccountName))
        {
            errorMessage = "Account name is required.";
            return;
        }

        isLoading = true;
        try
        {
            var (id, eventsUrl) = await Api.OpenAccountAsync(new OpenAccountCommand(newAccountName));

            isLoading = false;
            isWaitingForConfirmation = true;
            StateHasChanged();

            sseCts = new CancellationTokenSource(TimeSpan.FromSeconds(30));
            await Api.WaitForAccountEventAsync(eventsUrl, sseCts.Token);

            isWaitingForConfirmation = false;
            message = $"Account opened! ID: {id}";
            newAccountName = string.Empty;
            await LoadAccounts();
        }
        catch (OperationCanceledException)
        {
            isWaitingForConfirmation = false;
            message = "Account opened!";
            newAccountName = string.Empty;
            await LoadAccounts();
        }
        catch (Exception ex)
        {
            isWaitingForConfirmation = false;
            errorMessage = $"Failed to open account: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            sseCts?.Dispose();
            sseCts = null;
        }
    }
}
