@page "/accounts/{Id}"
@inject BankApiClient Api
@inject CustomerState State

@if (!State.IsLoggedIn)
{
    <div class="page-header">
        <h1 class="page-title">Account Details</h1>
    </div>
    <div class="card" style="max-width: 400px;">
        <div class="empty-state">
            <div class="empty-state-title">Not signed in</div>
            <div class="empty-state-text">Please <a href="/signin">sign in</a> to view account details.</div>
        </div>
    </div>
}
else if (account == null)
{
    <div class="loading-card">
        <div class="spinner"></div>
        <span>Loading account...</span>
    </div>
}
else
{
    <a href="accounts" class="back-link">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
        </svg>
        Back to Accounts
    </a>

    @* --- Account Summary Card --- *@
    <div class="card mb-4" style="max-width: 560px;">
        <div class="account-card-header">
            <span class="account-card-name" style="font-size: 1.15rem;">@account.AccountName</span>
            <span class="account-card-badge @(account.IsClosed ? "badge-closed" : "badge-active")">
                @(account.IsClosed ? "Closed" : "Active")
            </span>
        </div>
        <div class="account-card-sort-acct mt-2">@account.SortCode &middot; @account.AccountNumber</div>
        <div class="balance-hero mt-2">@account.Balance.ToString("C")</div>
        <div class="text-muted mt-2" style="font-size: 0.8rem;">Opened @account.OpenedAt.ToString("dd MMMM yyyy")</div>
    </div>

    @* --- Deposit & Withdraw Panels --- *@
    <div class="action-panels">
        <div class="card card-flat" style="border: 1px solid var(--card-border);">
            <div class="action-panel-header">
                <div class="action-panel-icon" style="background: var(--green-bg);">
                    <svg viewBox="0 0 24 24" fill="var(--green)" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/>
                    </svg>
                </div>
                <span class="action-panel-title">Deposit</span>
            </div>
            <div class="form-group">
                <label class="form-label">Amount</label>
                <input type="number" step="0.01" min="0.01" class="form-input" @bind="depositAmount" placeholder="0.00" />
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <input type="text" class="form-input" @bind="depositDescription" placeholder="e.g. Salary" />
            </div>
            <button type="button" class="btn btn-success btn-full" @onclick="Deposit" disabled="@isLoading">Deposit</button>
        </div>

        <div class="card card-flat" style="border: 1px solid var(--card-border);">
            <div class="action-panel-header">
                <div class="action-panel-icon" style="background: var(--amber-bg);">
                    <svg viewBox="0 0 24 24" fill="var(--amber)" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 4l1.41 1.41L7.83 11H20v2H7.83l5.58 5.59L12 20l-8-8z"/>
                    </svg>
                </div>
                <span class="action-panel-title">Withdraw</span>
            </div>
            <div class="form-group">
                <label class="form-label">Amount</label>
                <input type="number" step="0.01" min="0.01" class="form-input" @bind="withdrawAmount" placeholder="0.00" />
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <input type="text" class="form-input" @bind="withdrawDescription" placeholder="e.g. Rent payment" />
            </div>
            <button type="button" class="btn btn-warning btn-full" @onclick="Withdraw" disabled="@isLoading">Withdraw</button>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(message))
    {
        <div class="alert alert-success">@message</div>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-error">@errorMessage</div>
    }

    @* --- Transaction History --- *@
    <div class="card">
        <div class="section-header">
            <h3 class="section-title">Transaction History</h3>
        </div>

        @if (transactions == null)
        {
            <div class="loading-card">
                <div class="spinner"></div>
                <span>Loading transactions...</span>
            </div>
        }
        else if (transactions.Count == 0)
        {
            <div class="empty-state">
                <div class="empty-state-title">No transactions yet</div>
                <div class="empty-state-text">Make a deposit or withdrawal to see your history here.</div>
            </div>
        }
        else
        {
            <div class="tx-list">
                @foreach (var tx in transactions)
                {
                    <div class="tx-item">
                        <div class="tx-icon @GetTxIconClass(tx.Type)">
                            @((MarkupString)GetTxIconSvg(tx.Type))
                        </div>
                        <div class="tx-details">
                            <div class="tx-type">@tx.Type</div>
                            <div class="tx-description">@(string.IsNullOrEmpty(tx.Description) ? "No description" : tx.Description)</div>
                            <div class="tx-date">@tx.OccurredAt.ToString("dd MMM yyyy, HH:mm")</div>
                        </div>
                        <div class="tx-amounts">
                            <div class="tx-amount @GetTxAmountClass(tx.Type)">
                                @GetTxAmountPrefix(tx.Type)@tx.Amount.ToString("C")
                            </div>
                            <div class="tx-balance-after">Bal: @tx.BalanceAfter.ToString("C")</div>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
}

@code {
    [Parameter] public string Id { get; set; } = string.Empty;

    private AccountReadModel? account;
    private List<TransactionReadModel>? transactions;
    private decimal depositAmount;
    private string depositDescription = string.Empty;
    private decimal withdrawAmount;
    private string withdrawDescription = string.Empty;
    private string? message;
    private string? errorMessage;
    private bool isLoading;

    private Guid AccountId => Guid.Parse(Id);

    protected override async Task OnInitializedAsync()
    {
        if (State.IsLoggedIn)
        {
            await LoadData();
        }
    }

    private async Task LoadData()
    {
        var accounts = await Api.GetAccountsAsync(State.CustomerId!.Value);
        account = accounts.FirstOrDefault(a => a.Id == AccountId);
        transactions = await Api.GetTransactionsAsync(AccountId);
    }

    private async Task Deposit()
    {
        message = null;
        errorMessage = null;

        if (depositAmount <= 0)
        {
            errorMessage = "Amount must be greater than zero.";
            return;
        }

        isLoading = true;
        try
        {
            await Api.DepositAsync(AccountId, new DepositCommand(depositAmount, depositDescription));
            message = $"Deposited {depositAmount:C} successfully.";
            depositAmount = 0;
            depositDescription = string.Empty;
            await LoadData();
        }
        catch (Exception ex)
        {
            errorMessage = $"Deposit failed: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task Withdraw()
    {
        message = null;
        errorMessage = null;

        if (withdrawAmount <= 0)
        {
            errorMessage = "Amount must be greater than zero.";
            return;
        }

        isLoading = true;
        try
        {
            await Api.WithdrawAsync(AccountId, new WithdrawCommand(withdrawAmount, withdrawDescription));
            message = $"Withdrew {withdrawAmount:C} successfully.";
            withdrawAmount = 0;
            withdrawDescription = string.Empty;
            await LoadData();
        }
        catch (Exception ex)
        {
            errorMessage = $"Withdrawal failed: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private static string GetTxIconClass(TransactionType type) => type switch
    {
        TransactionType.Credit => "tx-icon-deposit",
        TransactionType.Debit => "tx-icon-withdrawal",
        _ => "tx-icon-transfer"
    };

    private static string GetTxIconSvg(TransactionType type) => type switch
    {
        TransactionType.Credit => """<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/></svg>""",
        TransactionType.Debit => """<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 4l1.41 1.41L7.83 11H20v2H7.83l5.58 5.59L12 20l-8-8z"/></svg>""",
        _ => """<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z"/></svg>"""
    };

    private static string GetTxAmountClass(TransactionType type) => type switch
    {
        TransactionType.Credit => "tx-amount-positive",
        TransactionType.Debit => "tx-amount-negative",
        _ => "tx-amount-neutral"
    };

    private static string GetTxAmountPrefix(TransactionType type) => type switch
    {
        TransactionType.Credit => "+",
        TransactionType.Debit => "-",
        _ => ""
    };
}
