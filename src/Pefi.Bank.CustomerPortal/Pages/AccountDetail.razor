@page "/accounts/{Id}"
@inject BankApiClient Api
@inject CustomerState State

<h2>Account Details</h2>

@if (!State.IsLoggedIn)
{
    <p>Please <a href="">sign in</a> first.</p>
}
else if (account == null)
{
    <p>Loading account...</p>
}
else
{
    <div style="margin-bottom: 20px; padding: 16px; border: 1px solid #dee2e6; border-radius: 6px; max-width: 500px;">
        <h4>@account.AccountName</h4>
        <p style="font-size: 1.5rem; font-weight: 600; margin: 8px 0;">@account.Balance.ToString("C")</p>
        <p style="color: #666; margin: 4px 0;">Status: @(account.IsClosed ? "Closed" : "Active")</p>
        <p style="color: #999; font-size: 0.85rem;">Opened: @account.OpenedAt.ToString("yyyy-MM-dd")</p>
    </div>

    <div style="display: flex; gap: 20px; margin-bottom: 24px; flex-wrap: wrap;">
        <div style="padding: 16px; border: 1px solid #dee2e6; border-radius: 6px; min-width: 250px;">
            <h5>Deposit</h5>
            <div style="display: flex; flex-direction: column; gap: 8px;">
                <input type="number" step="0.01" min="0.01" @bind="depositAmount" placeholder="Amount"
                       style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px;" />
                <input type="text" @bind="depositDescription" placeholder="Description"
                       style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px;" />
                <button class="btn btn-success btn-sm" @onclick="Deposit" disabled="@isLoading">Deposit</button>
            </div>
        </div>

        <div style="padding: 16px; border: 1px solid #dee2e6; border-radius: 6px; min-width: 250px;">
            <h5>Withdraw</h5>
            <div style="display: flex; flex-direction: column; gap: 8px;">
                <input type="number" step="0.01" min="0.01" @bind="withdrawAmount" placeholder="Amount"
                       style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px;" />
                <input type="text" @bind="withdrawDescription" placeholder="Description"
                       style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px;" />
                <button class="btn btn-warning btn-sm" @onclick="Withdraw" disabled="@isLoading">Withdraw</button>
            </div>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(message))
    {
        <div style="margin-bottom: 12px; padding: 10px; background-color: #d1e7dd; color: #0f5132; border-radius: 4px; max-width: 500px;">
            @message
        </div>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div style="margin-bottom: 12px; padding: 10px; background-color: #f8d7da; color: #842029; border-radius: 4px; max-width: 500px;">
            @errorMessage
        </div>
    }

    <h4>Transaction History</h4>

    @if (transactions == null)
    {
        <p>Loading transactions...</p>
    }
    else if (transactions.Count == 0)
    {
        <p>No transactions yet.</p>
    }
    else
    {
        <table style="width: 100%; max-width: 800px; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 2px solid #dee2e6; text-align: left;">
                    <th style="padding: 8px;">Date</th>
                    <th style="padding: 8px;">Type</th>
                    <th style="padding: 8px;">Amount</th>
                    <th style="padding: 8px;">Description</th>
                    <th style="padding: 8px;">Balance After</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var tx in transactions)
                {
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 8px;">@tx.OccurredAt.ToString("yyyy-MM-dd HH:mm")</td>
                        <td style="padding: 8px;">@tx.Type</td>
                        <td style="padding: 8px;">@tx.Amount.ToString("C")</td>
                        <td style="padding: 8px;">@tx.Description</td>
                        <td style="padding: 8px;">@tx.BalanceAfter.ToString("C")</td>
                    </tr>
                }
            </tbody>
        </table>
    }

    <div style="margin-top: 16px;">
        <a href="accounts">Back to Accounts</a>
    </div>
}

@code {
    [Parameter] public string Id { get; set; } = string.Empty;

    private AccountReadModel? account;
    private List<TransactionReadModel>? transactions;
    private decimal depositAmount;
    private string depositDescription = string.Empty;
    private decimal withdrawAmount;
    private string withdrawDescription = string.Empty;
    private string? message;
    private string? errorMessage;
    private bool isLoading;

    private Guid AccountId => Guid.Parse(Id);

    protected override async Task OnInitializedAsync()
    {
        if (State.IsLoggedIn)
        {
            await LoadData();
        }
    }

    private async Task LoadData()
    {
        var accounts = await Api.GetAccountsAsync(State.CustomerId!.Value);
        account = accounts.FirstOrDefault(a => a.Id == AccountId);
        transactions = await Api.GetTransactionsAsync(AccountId);
    }

    private async Task Deposit()
    {
        message = null;
        errorMessage = null;

        if (depositAmount <= 0)
        {
            errorMessage = "Amount must be greater than zero.";
            return;
        }

        isLoading = true;
        try
        {
            await Api.DepositAsync(AccountId, new DepositCommand(depositAmount, depositDescription));
            message = $"Deposited {depositAmount:C} successfully.";
            depositAmount = 0;
            depositDescription = string.Empty;
            await LoadData();
        }
        catch (Exception ex)
        {
            errorMessage = $"Deposit failed: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task Withdraw()
    {
        message = null;
        errorMessage = null;

        if (withdrawAmount <= 0)
        {
            errorMessage = "Amount must be greater than zero.";
            return;
        }

        isLoading = true;
        try
        {
            await Api.WithdrawAsync(AccountId, new WithdrawCommand(withdrawAmount, withdrawDescription));
            message = $"Withdrew {withdrawAmount:C} successfully.";
            withdrawAmount = 0;
            withdrawDescription = string.Empty;
            await LoadData();
        }
        catch (Exception ex)
        {
            errorMessage = $"Withdrawal failed: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}
