@page "/transfer"
@inject BankApiClient Api
@inject CustomerState State

@if (!State.IsLoggedIn)
{
    <div class="page-header">
        <h1 class="page-title">Transfer</h1>
    </div>
    <div class="card" style="max-width: 400px;">
        <div class="empty-state">
            <div class="empty-state-title">Not signed in</div>
            <div class="empty-state-text">Please <a href="">sign in</a> to make transfers.</div>
        </div>
    </div>
}
else if (accounts == null)
{
    <div class="page-header">
        <h1 class="page-title">Transfer</h1>
        <p class="page-subtitle">Move money between your accounts</p>
    </div>
    <div class="loading-card">
        <div class="spinner"></div>
        <span>Loading accounts...</span>
    </div>
}
else if (accounts.Count < 2)
{
    <div class="page-header">
        <h1 class="page-title">Transfer</h1>
        <p class="page-subtitle">Move money between your accounts</p>
    </div>
    <div class="card" style="max-width: 480px;">
        <div class="empty-state">
            <svg class="empty-state-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z"/>
            </svg>
            <div class="empty-state-title">Need more accounts</div>
            <div class="empty-state-text">You need at least two accounts to make a transfer. <a href="accounts">Open an account</a>.</div>
        </div>
    </div>
}
else
{
    <div class="page-header">
        <h1 class="page-title">Transfer</h1>
        <p class="page-subtitle">Move money between your accounts</p>
    </div>

    <div class="card" style="max-width: 480px;">
        <div class="form-group">
            <label class="form-label">From Account</label>
            <select class="form-select" @bind="sourceAccountId">
                <option value="">Select source account</option>
                @foreach (var acct in accounts.Where(a => !a.IsClosed))
                {
                    <option value="@acct.Id">@acct.AccountName &middot; @acct.AccountNumber (@acct.Balance.ToString("C"))</option>
                }
            </select>
        </div>

        <div class="transfer-arrow">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z" transform="rotate(90 12 12)"/>
            </svg>
        </div>

        <div class="form-group">
            <label class="form-label">To Account</label>
            <select class="form-select" @bind="destinationAccountId">
                <option value="">Select destination account</option>
                @foreach (var acct in accounts.Where(a => !a.IsClosed))
                {
                    <option value="@acct.Id">@acct.AccountName &middot; @acct.AccountNumber (@acct.Balance.ToString("C"))</option>
                }
            </select>
        </div>

        <div class="form-group mt-3">
            <label class="form-label">Amount</label>
            <input type="number" step="0.01" min="0.01" class="form-input" @bind="amount" placeholder="0.00" />
        </div>

        <div class="form-group">
            <label class="form-label">Description (optional)</label>
            <input type="text" class="form-input" @bind="description" placeholder="What's this transfer for?" />
        </div>

        <button class="btn btn-primary btn-full mt-3" @onclick="SubmitTransfer" disabled="@isLoading">
            @(isLoading ? "Processing..." : "Transfer")
        </button>
    </div>

    @if (!string.IsNullOrEmpty(message))
    {
        <div class="alert alert-success mt-3" style="max-width: 480px;">@message</div>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-error mt-3" style="max-width: 480px;">@errorMessage</div>
    }
}

@code {
    private List<AccountReadModel>? accounts;
    private string sourceAccountId = string.Empty;
    private string destinationAccountId = string.Empty;
    private decimal amount;
    private string description = string.Empty;
    private string? message;
    private string? errorMessage;
    private bool isLoading;

    protected override async Task OnInitializedAsync()
    {
        if (State.IsLoggedIn)
        {
            accounts = await Api.GetAccountsAsync(State.CustomerId!.Value);
        }
    }

    private async Task SubmitTransfer()
    {
        message = null;
        errorMessage = null;

        if (string.IsNullOrEmpty(sourceAccountId) || string.IsNullOrEmpty(destinationAccountId))
        {
            errorMessage = "Please select both source and destination accounts.";
            return;
        }

        if (sourceAccountId == destinationAccountId)
        {
            errorMessage = "Source and destination must be different accounts.";
            return;
        }

        if (amount <= 0)
        {
            errorMessage = "Amount must be greater than zero.";
            return;
        }

        isLoading = true;
        try
        {
            var command = new TransferCommand(
                Guid.Parse(sourceAccountId),
                Guid.Parse(destinationAccountId),
                amount,
                description);

            await Api.TransferAsync(command);
            message = $"Transfer of {amount:C} completed successfully.";
            amount = 0;
            description = string.Empty;
            sourceAccountId = string.Empty;
            destinationAccountId = string.Empty;
            accounts = await Api.GetAccountsAsync(State.CustomerId!.Value);
        }
        catch (Exception ex)
        {
            errorMessage = $"Transfer failed: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}
